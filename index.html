<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EggScream ‚Äî $1 Make It Scream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="canonical" href="https://www.eggscream.com/">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --yellow:#FFD600; --red:#FF0033; --blue:#0066FF; --offwhite:#FFF8E1; --ink:#0f0f0f;
      --line:#f0dede;
    }
    html,body{margin:0;background:var(--offwhite);color:var(--ink)}
    body{font:16px/1.4 "Comic Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}

    /* --- Hero con strisce --- */
    .hero{
      min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:48px 18px;
      background:
        repeating-linear-gradient(135deg,#fff 0 24px,#ffecec 24px 48px),
        linear-gradient(var(--offwhite),var(--offwhite));
    }
    .card{
      width:min(980px,94vw); text-align:center; background:#fff;
      border:4px solid #111; border-radius:26px; padding:36px 28px;
      box-shadow:0 28px 60px rgba(0,0,0,.25);
    }

    .tag{
      display:inline-block; background:#fff; border:4px solid #111; border-radius:999px;
      padding:.35rem .8rem; font-family:"Bangers", system-ui; letter-spacing:.02em; font-size:clamp(14px,2.6vw,18px);
    }

    h1{
      font-family:"Bangers", system-ui; text-transform:uppercase; letter-spacing:.02em;
      margin:.6rem 0 .25rem; line-height:1.02; font-size:clamp(40px,8.5vw,96px);
    }
    .sub{ margin:.25rem 0 0; font-weight:700; font-size:clamp(16px,3.2vw,22px); }

    /* --- STAGE --- */
    .stage{
      position:relative; margin:24px auto 0; height:320px; border:3px dashed var(--line); border-radius:22px;
      display:flex; align-items:center; justify-content:center; background:linear-gradient(#fff,#fafafa); overflow:hidden;
      transition:transform .08s ease;
    }
    .spark{ position:absolute; font-size:26px; opacity:.22; animation:pop 1.2s infinite }
    .spark.s1{ left:14%; top:22% } .spark.s2{ right:12%; top:18% } .spark.s3{ left:10%; bottom:14% } .spark.s4{ right:8%; bottom:12% }
    @keyframes pop{ 0%,100%{ transform:scale(1) rotate(0) } 50%{ transform:scale(1.2) rotate(10deg) } }

    /* Gallina ‚Äì stessa grafica, centrata e con origin coerente */
    .chicken{
      width:min(360px,76vw);
      transform:rotate(-4deg);
      transform-origin:center center;
      position:relative;
      margin:0 auto;
    }

    /* Occhio blink */
    .eye{ animation:eyeBlink 4.2s infinite; transform-origin:170px 105px }
    @keyframes eyeBlink{ 0%,96%,100%{ transform:scaleY(1) } 98%{ transform:scaleY(.1) } }

    /* Cresta idle + sway durante urlo */
    .crest{ transform-origin:170px 82px; animation:crestBlink .9s steps(2,end) infinite }
    @keyframes crestBlink{ 0%,100%{ fill:var(--red) } 50%{ fill:var(--blue) } }
    .scream .crest{ animation:crestSway .18s ease-in-out infinite }
    @keyframes crestSway{ 0%{transform:rotate(0)} 50%{transform:rotate(-7deg)} 100%{transform:rotate(0)} }

    /* Becco che si apre in scream */
    .beak-upper,.beak-lower{ transform-origin:182px 120px; transition:transform .08s ease }
    .scream .beak-upper{ transform:rotate(-22deg) translateY(-2px) }
    .scream .beak-lower{ transform:rotate(22deg) translateY(6px) }

    /* Ala che ‚Äúpompa‚Äù a tempo */
    .wing{ transform-origin:125px 125px }
    .beat .wing{ animation:flap .24s ease-out }
    @keyframes flap{ 0%{transform:rotate(0)} 50%{transform:rotate(-8deg)} 100%{transform:rotate(0)} }

    /* ‚ÄúRespiro‚Äù idle + micro pump sui colpi (senza translateX) */
    .chicken.breathe { animation: chickenBreathe 3s ease-in-out infinite }
    @keyframes chickenBreathe { 0%,100%{ transform:rotate(-4deg) scale(1) } 50%{ transform:rotate(-4deg) scale(1.01) } }
    .chicken.pump { animation: chickenPump .12s ease-out 1 }
    @keyframes chickenPump { 0%{transform:rotate(-4deg)} 50%{transform:rotate(-4.6deg)} 100%{transform:rotate(-4deg)} }
    .crest.bob { animation: crestBob .12s ease-out 1; transform-origin:170px 82px }
    @keyframes crestBob { 0%{transform:rotate(0)} 50%{transform:rotate(-7deg)} 100%{transform:rotate(0)} }

    /* AAA */
    .shout{
      position:absolute; left:calc(50% + 150px); top:86px; transform:translateX(-50%) rotate(-3deg);
      font-family:"Bangers"; font-size:clamp(22px,4.5vw,36px); color:#FF0033; text-shadow:0 3px #fff, 3px 3px #111;
      user-select:none; pointer-events:none; white-space:nowrap; opacity:0; transition:opacity .08s ease, transform .08s ease;
    }
    .scream .shout{ opacity:1; transform:translateX(-50%) }

    /* Uova che cadono + mini ‚Äúaa‚Äù */
    .egg, .chickAA{
      position:absolute; will-change:transform,opacity; filter:drop-shadow(0 2px 2px rgba(0,0,0,.15));
      pointer-events:none; z-index:3;
    }
    .egg{ top:-44px; font-size:32px }
    @keyframes fall{
      0%{ transform:translate(var(--x,0), -44px) rotate(0deg); opacity:0 }
      8%{ opacity:1 } 92%{ transform:translate(var(--x,0), 260px) rotate(340deg) }
      100%{ transform:translate(var(--x,0), 265px) rotate(360deg); opacity:.98 }
    }
    .miniAA{ position:absolute; font-weight:900; font-size:14px; color:#e11; text-shadow:0 1px 0 #fff,1px 1px 0 rgba(0,0,0,.14); opacity:0; z-index:4 }
    @keyframes aaPop{ 0%{transform:translateY(0) scale(.8);opacity:0} 30%{opacity:1} 100%{transform:translateY(-8px) scale(1.06);opacity:0} }

    /* CTA con pulse */
    .cta{
      position:relative; display:inline-block; margin-top:22px; padding:1.05rem 1.35rem;
      background:var(--yellow); color:#111; text-decoration:none;
      border:4px solid #FF0033; border-radius:16px;
      box-shadow:0 8px 0 #111, 0 12px 24px rgba(0,0,0,.25);
      transform:translateY(0);
      font-family:"Bangers"; font-size:clamp(16px,3.6vw,26px); letter-spacing:.02em;
      transition:transform .08s ease, box-shadow .08s ease, filter .12s ease; overflow:visible;
    }
    .cta::after{ content:""; position:absolute; inset:-6px; border-radius:inherit; pointer-events:none;
      box-shadow:0 0 0 0 rgba(255,0,51,.34); animation:btnPulse 2.2s ease-out infinite; }
    @keyframes btnPulse{ 0%{box-shadow:0 0 0 0 rgba(255,0,51,.34)} 70%{box-shadow:0 0 0 18px rgba(255,0,51,0)} 100%{box-shadow:0 0 0 0 rgba(255,0,51,0)} }
    .cta:hover{ filter:saturate(1.1) }
    .cta:active{ transform:translateY(2px); box-shadow:0 6px 0 #111 }

    .disclaimers{ margin:14px auto 0; max-width:680px; list-style:none; padding:0; color:#333; font-weight:700; font-size:clamp(12px,2.6vw,14px) }
    .disclaimers li{ margin:.25rem 0 }

    /* Barra misura */
    .measure{position:absolute; left:0; right:0; top:0; height:6px; background:rgba(0,0,0,.06)}
    .bar{position:absolute; left:0; top:0; bottom:0; width:0; background:linear-gradient(90deg,#ff8a8a 0 60%, #88c7ff 60% 100%); border-bottom-right-radius:6px}
    .playing .bar{ animation:measure 5s linear infinite }
    @keyframes measure{from{width:0} to{width:100%}}

    /* Controlli post-pagamento */
    .controls{ display:none; gap:10px; justify-content:center; margin:16px 0 0 }
    .controls .btn{ border:3px solid #111; background:#fff; padding:.6rem .9rem; border-radius:12px; font-weight:900; cursor:pointer }
    .controls .btn:active{ transform:translateY(1px) }

    /* Modale pagamento */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); backdrop-filter:blur(3px);
      align-items:center; justify-content:center; z-index:100 }
    .modal:target{ display:flex }
    .sheet{
      width:min(520px,92vw); background:#fff; border:4px solid #111; border-radius:22px; padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.45); text-align:center;
    }
    .paybtn{ display:block; margin:12px 0 0; padding:12px 14px; border-radius:12px; color:#fff; text-decoration:none; font-weight:900; background:#635bff; }
    .close{ display:inline-block; margin-top:12px; padding:.6rem .9rem; border:3px solid #111; border-radius:12px; background:#f3f3f3; text-decoration:none; color:#111; font-weight:900; }
  </style>
</head>
<body>
  <main class="hero">
    <section class="card" aria-labelledby="title">
      <span class="tag">TURN UP THE SCREECH</span>
      <h1 id="title">$1 ‚Ä¢ MAKE IT SCREAM</h1>
      <p class="sub">The cheapest scream therapy on the web.</p>

      <div class="stage" id="stage" aria-hidden="true">
        <div class="measure"><div class="bar"></div></div>

        <!-- decor -->
        <div class="spark s1">‚≠ê</div><div class="spark s2">‚≠ê</div>
        <div class="spark s3">‚≠ê</div><div class="spark s4">‚≠ê</div>

        <!-- gallina -->
        <div class="chicken">
          <svg viewBox="0 0 260 210" aria-hidden="true">
            <g class="body">
              <ellipse cx="140" cy="135" rx="95" ry="72" fill="#fff" stroke="#111" stroke-width="5"/>
              <ellipse cx="140" cy="150" rx="70" ry="46" fill="#fefefe" stroke="#0000"/>
            </g>
            <ellipse class="wing" cx="110" cy="135" rx="40" ry="28" fill="#fff" stroke="#111" stroke-width="4"/>
            <circle class="eye" cx="170" cy="105" r="7" fill="#111"/>
            <path class="crest" d="M150 75 C155 55,175 50,180 70 C186 50,205 52,202 72 C195 56,176 58,170 77 Z"
                  fill="#FF0033" stroke="#111" stroke-width="4"/>
            <g fill="#ffb628" stroke="#111" stroke-width="4">
              <path class="beak-upper" d="M182 120 L225 110 L182 104 Z"/>
              <path class="beak-lower" d="M182 121 L226 134 L182 127 Z"/>
            </g>
            <path d="M120 198 l0-28 M160 198 l0-28" stroke="#111" stroke-width="6" />
          </svg>
          <div class="shout">AAA!!!</div>
        </div>
      </div>

      <a class="cta" href="#pay">üí•üêîü•ö $1 MAKE IT SCREAM ‚Äî PLAY THE BEAT üí•üêîü•ö</a>

      <ul class="disclaimers" aria-label="disclaimers">
        <li>No refunds. Only scream.</li>
        <li>Volume HIGHLY recommended.</li>
        <li>As American as fried chicken at 3 AM.</li>
      </ul>

      <!-- Controlli post-pagamento -->
      <div class="controls" id="controls">
        <button id="startBtn" class="btn">üîä Start Beat</button>
        <button id="stopBtn"  class="btn" style="display:none">üõë Stop</button>
        <button id="eggBtn"   class="btn" title="Unleash the chaos">ü•öüí• EGGSplosion</button>
      </div>
    </section>
  </main>

  <!-- Modal pagamento -->
  <div id="pay" class="modal" onclick="location.hash=''">
    <div class="sheet" onclick="event.stopPropagation()">
      <h3 style="font-family:'Bangers'; font-size:28px; margin:0 0 .25rem">INSERT $1</h3>
      <p style="margin:.25rem 0 .5rem"><strong>‚Üí instant screech therapy.</strong></p>
      <a class="paybtn" href="https://buy.stripe.com/test_dRm8wI5wBf9l21W20P9oc01?success=1" target="_self" rel="noopener">Pay with Stripe</a>
      <a class="close" href="#">Cancel</a>
    </div>
  </div>

  <script>
  (function(){
    const stage = document.getElementById('stage');
    const bar   = stage.querySelector('.bar');
    const controls = document.getElementById('controls');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const eggBtn   = document.getElementById('eggBtn');
    const chicken  = stage.querySelector('.chicken');
    const crestEl  = stage.querySelector('.crest');

    // mostra i controlli solo se ?success=1
    const url = new URL(location.href);
    if (url.searchParams.get('success') === '1') controls.style.display = 'flex';

    chicken.classList.add('breathe');

    /* ===== Stato audio ===== */
    let ctx=null, loopTimer=null, cleanup=null, MEASURE=0;
    let master=null, softLim=null, comp=null;
    let timeouts=[];

    const SWING = (window.innerWidth < 700 ? 0.03 : 0.04);
    const LANES = [12, 31, 50, 69, 88];

    function ac(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); return ctx; }
    function onTimer(fn, ms){ const id=setTimeout(fn, ms); timeouts.push(id); return id; }
    function clearAllTimers(){ timeouts.forEach(clearTimeout); timeouts.length=0; }

    function mkDist(c, amt=24){
      const ws=c.createWaveShaper(), n=512, curve=new Float32Array(n);
      for(let i=0;i<n;i++){ const x=i/n*2-1; curve[i]=Math.tanh(amt*x); }
      ws.curve=curve; ws.oversample='4x'; return ws;
    }

    /* ===== Audio Unlock (mobile + desktop) ===== */
    let audioUnlocked=false;
    async function unlockAudio(){
      const c=ac();
      try{ await c.resume(); }catch(e){}
      try{ // micro ‚Äútick‚Äù muto per sbloccare iOS
        const o=c.createOscillator(), g=c.createGain();
        g.gain.value=0; o.connect(g).connect(c.destination);
        o.start(c.currentTime); o.stop(c.currentTime+0.01);
      }catch(e){}
      audioUnlocked=true;
    }
    window.addEventListener('pointerdown', ()=>{ if(!audioUnlocked) unlockAudio(); }, {once:true, passive:true});
    window.addEventListener('keydown', ()=>{ if(!audioUnlocked) unlockAudio(); }, {once:true});

    /* ===== Visual ===== */
    function setScream(on){
      stage.classList.toggle('scream', !!on);
      const shoutEl = stage.querySelector('.shout');
      if (shoutEl) shoutEl.style.opacity = on ? '1' : '0';
    }
    function pulseWing(){ stage.classList.add('beat'); onTimer(()=>stage.classList.remove('beat'), 150); }
    function pumpChickenAt(when){
      const c = ac(); const ms = Math.max(0, (when - c.currentTime) * 1000);
      onTimer(()=>{
        chicken.classList.remove('pump'); void chicken.offsetWidth; chicken.classList.add('pump');
        crestEl.classList.remove('bob');   void crestEl.offsetWidth; crestEl.classList.add('bob');
      }, ms);
    }
    function thumpAt(c, when){
      const ms = Math.max(0, (when - c.currentTime) * 1000);
      onTimer(()=>{
        stage.style.transform='scale(1.012)';
        onTimer(()=>{ stage.style.transform='scale(1)'; }, 90);
      }, ms);
    }

    /* ===== Suoni base ===== */
    function kickPlop(c,t,out){ const o=c.createOscillator(); o.type='sine';
      const g=c.createGain(); o.frequency.setValueAtTime(140,t);
      o.frequency.exponentialRampToValueAtTime(55,t+0.16);
      g.gain.setValueAtTime(1.05,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.18);
      o.connect(g).connect(out); o.start(t); o.stop(t+0.19); }
    function snareCluck(c,t,out){ const o=c.createOscillator(); o.type='square';
      const g=c.createGain(); o.frequency.setValueAtTime(750,t);
      o.frequency.exponentialRampToValueAtTime(300,t+0.07);
      g.gain.setValueAtTime(0.95,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.1);
      o.connect(g).connect(out); o.start(t); o.stop(t+0.11); }
    function hatClick(c,t,out,gain=0.42){
      const buf=c.createBuffer(1, Math.floor(c.sampleRate*0.05), c.sampleRate);
      const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.9;
      const n=c.createBufferSource(); n.buffer=buf;
      const hp=c.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=5000;
      const g=c.createGain(); g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.05);
      n.connect(hp).connect(g).connect(out); n.start(t); n.stop(t+0.06);
    }

    /* ===== Mini ‚Äúaa‚Äù trash therapy ===== */
    function babyTherapyAA(c, t, out, {len=0.34, pitch=1.6, gain=0.58, detCents=8, tremHz=14, distAmt=18, voices=2, cluster=2, clusterGap=0.035}={}){
      for (let k=0;k<cluster;k++){
        const tt=t+k*clusterGap;
        const bus=c.createGain(); bus.gain.setValueAtTime(0.0001,tt);
        bus.gain.exponentialRampToValueAtTime(gain,tt+0.02);
        bus.gain.exponentialRampToValueAtTime(0.0001,tt+len);
        const dist=mkDist(c,distAmt), bp=c.createBiquadFilter(), lp=c.createBiquadFilter();
        bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=5; lp.type='lowpass'; lp.frequency.value=3200;
        const sum=c.createGain(); sum.connect(dist).connect(bp).connect(lp).connect(bus).connect(out);
        for(let v=0; v<voices; v++){
          const det=(v===0?-detCents:+detCents);
          const o=c.createOscillator(); o.type='sawtooth';
          const g=c.createGain(); const f0=620*pitch;
          o.frequency.setValueAtTime(f0,tt); o.detune.setValueAtTime(det,tt);
          o.frequency.linearRampToValueAtTime(f0*1.16, tt+0.05);
          o.frequency.exponentialRampToValueAtTime(f0*0.26, tt+len*0.85);
          g.gain.setValueAtTime(0.0001,tt); g.gain.exponentialRampToValueAtTime(0.95,tt+0.035);
          g.gain.exponentialRampToValueAtTime(0.0001,tt+len);
          const trem=c.createOscillator(); trem.frequency.value=tremHz;
          const tremAmt=c.createGain(); tremAmt.gain.value=0.7; trem.connect(tremAmt.gain); g.connect(tremAmt);
          o.connect(g).connect(sum); trem.start(tt); trem.stop(tt+len); o.start(tt); o.stop(tt+len);
        }
        const nb=c.createBuffer(1, Math.floor(c.sampleRate*len), c.sampleRate);
        const nd=nb.getChannelData(0); for(let i=0;i<nd.length;i++) nd[i]=Math.random()*2-1;
        const n=c.createBufferSource(); n.buffer=nb;
        const nBP=c.createBiquadFilter(); nBP.type='bandpass'; nBP.frequency.value=2400; nBP.Q.value=6;
        const ng=c.createGain(); ng.gain.setValueAtTime(0.001, tt+0.03); ng.gain.exponentialRampToValueAtTime(0.22, tt+0.08);
        ng.gain.exponentialRampToValueAtTime(0.0001, tt+len);
        n.connect(nBP).connect(ng).connect(sum); n.start(tt); n.stop(tt+len);
      }
    }

    function spawnMiniAAnearEl(el){
      const aa=document.createElement('span'); aa.className='miniAA'; aa.textContent='aa';
      const r=el.getBoundingClientRect(), rs=stage.getBoundingClientRect();
      aa.style.left = (r.left - rs.left + 18) + 'px'; aa.style.top  = (r.top  - rs.top  - 12) + 'px';
      stage.appendChild(aa); aa.style.animation='aaPop .24s ease-out forwards'; onTimer(()=>aa.remove(),260);
    }

    function dropEggAt(lanePct, at, hatchMode){
      const c=ac(); const ms=Math.max(0,(at - c.currentTime)*1000);
      onTimer(()=>{
        const e=document.createElement('span'); e.className='egg'; e.textContent='ü•ö';
        const size=30 + Math.round(Math.random()*8);
        e.style.fontSize = size+'px'; e.style.left = `calc(${lanePct}% - ${size/2}px)`;
        e.style.setProperty('--x', (Math.random()*8 - 4) + 'px'); e.style.animation='fall 1.12s linear forwards';
        stage.appendChild(e);
        if (hatchMode){
          if (hatchMode==='air'){
            onTimer(()=>{ e.textContent='üê£'; spawnMiniAAnearEl(e); }, 480);
            if (master) babyTherapyAA(c, c.currentTime+0.48, master, { cluster:2, voices:2, pitch:1.65 });
          } else {
            onTimer(()=>{ e.textContent='üê£'; spawnMiniAAnearEl(e); }, 1080);
            if (master) babyTherapyAA(c, c.currentTime+1.08, master, { cluster:3, voices:2, pitch:1.55 });
          }
        }
        onTimer(()=>e.remove(), 1500);
      }, ms);
    }

    function chickenScream3s(c, t, out){
      setScream(true);
      const len=3.0;
      const bus=c.createGain(); bus.gain.value=1.0;
      const dist=mkDist(c,20);
      const bp=c.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=4.5;
      const lp=c.createBiquadFilter(); lp.type='lowpass';  lp.frequency.value=2800;
      bus.connect(dist).connect(bp).connect(lp).connect(out);

      [-10,+10].forEach(det=>{
        const o=c.createOscillator(); o.type='sawtooth';
        const g=c.createGain();
        o.frequency.setValueAtTime(620,t);
        o.detune.setValueAtTime(det,t);
        o.frequency.linearRampToValueAtTime(720, t+0.12);
        o.frequency.exponentialRampToValueAtTime(150, t+len*0.92);
        g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(0.95,t+0.06);
        g.gain.exponentialRampToValueAtTime(0.0001,t+len);
        const trem=c.createOscillator(); trem.frequency.value=13;
        const tremAmt=c.createGain(); tremAmt.gain.value=0.7;
        trem.connect(tremAmt.gain); g.connect(tremAmt);
        o.connect(g).connect(bus);
        trem.start(t); trem.stop(t+len);
        o.start(t); o.stop(t+len);
      });

      const nbuf=c.createBuffer(1, Math.floor(c.sampleRate*len), c.sampleRate);
      const d=nbuf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
      const n=c.createBufferSource(); n.buffer=nbuf;
      const nBP=c.createBiquadFilter(); nBP.type='bandpass'; nBP.frequency.value=2600; nBP.Q.value=6;
      const ng=c.createGain(); ng.gain.setValueAtTime(0.001, t+0.08); ng.gain.exponentialRampToValueAtTime(0.5, t+0.22);
      ng.gain.exponentialRampToValueAtTime(0.0001, t+len);
      n.connect(nBP).connect(ng).connect(bus); n.start(t); n.stop(t+len);

      for (let x=t+0.10; x < t+len-0.06; x += 0.25){
        hatClick(c, x, out, 0.18);
        const lane = (Math.round((x - t)/0.25) % 2) ? 31 : 50;
        dropEggAt(lane, x, null);
      }

      onTimer(()=>setScream(false), (len*1000)+60);
      return t+len;
    }

    function scheduleMeasure(c, start, out){
      const isFill = ((++MEASURE % 4) === 0);
      const dur=2.0, beat=0.5;

      if (isFill){
        const pre=Math.max(0, (start - 0.20 - c.currentTime)*1000);
        onTimer(()=>{ stage.classList.remove('flash'); void stage.offsetWidth; stage.classList.add('flash'); }, pre);
      }

      for(let i=0;i<4;i++){
        const t = start + i*beat;
        pulseWing(); pumpChickenAt(t);

        if (i===0 || i===2){ kickPlop(c,t,out); thumpAt(c,t); }
        else               { snareCluck(c,t,out); }

        hatClick(c,t,out, isFill?0.30:0.42);
        dropEggAt([12,69,31,88][i], t, Math.random()<0.18 ? (Math.random()<0.5?'air':'ground') : null);

        const off = t + beat/2 + (SWING*beat);
        hatClick(c, off, out, isFill?0.30:0.42);
        dropEggAt([50,31,50,69][i], off, Math.random()<0.28 ? (Math.random()<0.5?'air':'ground') : null);

        if (Math.random() < 0.85) babyTherapyAA(c, off, out, { cluster: isFill?3:2, voices:2 });
        if (i===1 || i===3){
          const s16=beat/4, preSnare=t - s16 + (SWING*beat*0.5);
          if (preSnare > start) babyTherapyAA(c, preSnare, out, { cluster:2, voices:2, pitch:1.5, len:0.30 });
        }

        if (isFill && i>=2){
          const s16=beat/4;
          [t+s16, t+2*s16, t+3*s16].forEach(tt=>{
            hatClick(c, tt, out, 0.26);
            dropEggAt(50, tt, Math.random()<0.5 ? (Math.random()<0.5?'air':'ground') : null);
          });
          if (Math.random()<0.5) babyTherapyAA(c, off, out, { cluster:3, voices:2 });
        }
      }
      return start+dur;
    }

    function restartProgress(){ bar.style.animation='none'; bar.offsetHeight; bar.style.animation=null; }

    function ensureMaster(){
      const c=ac();
      if (!master){
        master=c.createGain();
        softLim=mkDist(c,10);
        comp=c.createDynamicsCompressor();
        comp.threshold.value=-10; comp.knee.value=8; comp.ratio.value=6;
        comp.attack.value=0.002; comp.release.value=0.10;
        master.connect(softLim).connect(comp).connect(c.destination);
      }
      const now=c.currentTime+0.0005;
      try{
        master.gain.cancelScheduledValues(now);
        master.gain.setValueAtTime(1.10, now);
      }catch(e){}
      return c;
    }

    async function startLoop(){
      await unlockAudio();
      const c=ensureMaster();
      if (cleanup) { try{ cleanup(); }catch(e){} }
      clearAllTimers(); if (loopTimer) { clearInterval(loopTimer); loopTimer=null; }
      MEASURE=0;

      let base=c.currentTime+0.08;
      stage.classList.add('playing'); restartProgress();

      const afterS=chickenScream3s(c, base, master);
      scheduleMeasure(c, afterS+0.06, master);

      loopTimer=setInterval(()=>{
        base += 5.0; restartProgress();
        const endS=chickenScream3s(c, base, master);
        scheduleMeasure(c, endS+0.06, master);
      }, 5000);

      cleanup=()=>{ // stop rapido
        try{ clearInterval(loopTimer); }catch(e){} loopTimer=null;
        clearAllTimers();
        const now=c.currentTime;
        try{
          master.gain.cancelScheduledValues(now);
          master.gain.setValueAtTime(master.gain.value, now);
          master.gain.linearRampToValueAtTime(0.0001, now + 0.08);
        }catch(e){}
        stage.classList.remove('playing'); setScream(false);
      };

      startBtn.style.display='none'; stopBtn.style.display='inline-block';
    }

    function stopLoop(){
      if (cleanup) { try{ cleanup(); }catch(e){} }
      startBtn.style.display='inline-block'; stopBtn.style.display='none';
    }

    async function triggerEggsplosionBurst(){
      await unlockAudio();
      const c=ensureMaster();
      // suono immediato (senza timer) per iOS
      babyTherapyAA(c, c.currentTime, master, { cluster:2, voices:2, pitch:1.62 });

      const now=c.currentTime+0.03;
      for(let wave=0; wave<3; wave++){
        const base=now + wave*0.38;
        for(let i=0;i<18;i++){
          const t=base + i*0.02;
          const lane=LANES[Math.floor(Math.random()*LANES.length)];
          const mode=(Math.random()<0.7?'air':'ground');
          dropEggAt(lane, t, mode);
          if (Math.random()<0.92) babyTherapyAA(c, t+0.015, master, { cluster:2, voices:2, pitch:1.6 + Math.random()*0.15 });
        }
      }
    }

    if (startBtn){
      startBtn.addEventListener('click', startLoop, {passive:true});
      stopBtn .addEventListener('click', stopLoop,  {passive:true});
      eggBtn  .addEventListener('click', triggerEggsplosionBurst, {passive:true});
    }
  })();
  </script>
</body>
</html>

































