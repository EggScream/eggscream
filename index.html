<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EggScream — $1 Make It Scream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="canonical" href="https://www.eggscream.com/">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --yellow:#FFD600; --red:#FF0033; --blue:#0066FF; --offwhite:#FFF8E1; --ink:#0f0f0f;
      --line:#f0dede;
    }
    html,body{margin:0;background:var(--offwhite);color:var(--ink)}
    body{font:16px/1.4 "Comic Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}

    .hero{
      min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:48px 18px;
      background:
        repeating-linear-gradient(135deg,#fff 0 24px,#ffecec 24px 48px),
        linear-gradient(var(--offwhite),var(--offwhite));
    }
    .card{
      width:min(980px,94vw); text-align:center; background:#fff;
      border:4px solid #111; border-radius:26px; padding:36px 28px;
      box-shadow:0 28px 60px rgba(0,0,0,.25);
    }

    .tag{
      display:inline-block; background:#fff; border:4px solid #111; border-radius:999px;
      padding:.35rem .8rem; font-family:"Bangers", system-ui; letter-spacing:.02em; font-size:clamp(14px,2.6vw,18px);
    }

    h1{
      font-family:"Bangers", system-ui; text-transform:uppercase; letter-spacing:.02em;
      margin:.6rem 0 .25rem; line-height:1.02; font-size:clamp(40px,8.5vw,96px);
    }
    .sub{ margin:.25rem 0 0; font-weight:700; font-size:clamp(16px,3.2vw,22px); }

    .stage{
      position:relative; margin:24px auto 0; height:320px; border:3px dashed var(--line); border-radius:22px;
      display:flex; align-items:center; justify-content:center; background:linear-gradient(#fff,#fafafa); overflow:hidden;
      transition:transform .08s ease; will-change:transform;
    }
    .spark{ position:absolute; font-size:26px; opacity:.22; animation:pop 1.2s infinite }
    .spark.s1{ left:14%; top:22% } .spark.s2{ right:12%; top:18% } .spark.s3{ left:10%; bottom:14% } .spark.s4{ right:8%; bottom:12% }
    @keyframes pop{ 0%,100%{ transform:scale(1) rotate(0) } 50%{ transform:scale(1.2) rotate(10deg) } }

    .chicken{
      width:min(360px,76vw);
      transform:rotate(-4deg);
      transform-origin:center center;
      position:relative;
      margin:0 auto;
      will-change:transform;
    }

    .eye{ animation:eyeBlink 4.2s infinite; transform-origin:170px 105px }
    @keyframes eyeBlink{ 0%,96%,100%{ transform:scaleY(1) } 98%{ transform:scaleY(.1) } }

    .crest{ transform-origin:170px 82px; animation:crestBlink .9s steps(2,end) infinite }
    @keyframes crestBlink{ 0%,100%{ fill:var(--red) } 50%{ fill:var(--blue) } }
    .scream .crest{ animation:crestSway .18s ease-in-out infinite }
    @keyframes crestSway{ 0%{transform:rotate(0)} 50%{transform:rotate(-7deg)} 100%{transform:rotate(0)} }

    .beak-upper,.beak-lower{ transform-origin:182px 120px; transition:transform .08s ease }
    .scream .beak-upper{ transform:rotate(-22deg) translateY(-2px) }
    .scream .beak-lower{ transform:rotate(22deg) translateY(6px) }

    .wing{ transform-origin:125px 125px }
    .beat .wing{ animation:flap .24s ease-out }
    @keyframes flap{ 0%{transform:rotate(0)} 50%{transform:rotate(-8deg)} 100%{transform:rotate(0)} }

    .chicken.breathe { animation: chickenBreathe 3s ease-in-out infinite }
    @keyframes chickenBreathe {
      0%,100%{ transform:rotate(-4deg) scale(1) }
      50%    { transform:rotate(-4deg) scale(1.01) }
    }
    .chicken.pump { animation: chickenPump .12s ease-out 1 }
    @keyframes chickenPump {
      0%   { transform: rotate(-4deg) }
      50%  { transform: rotate(-4.6deg) }
      100% { transform: rotate(-4deg) }
    }
    .crest.bob { animation: crestBob .12s ease-out 1; transform-origin:170px 82px }
    @keyframes crestBob { 0%{transform:rotate(0)} 50%{transform:rotate(-7deg)} 100%{transform:rotate(0)} }

    .shout{
      position:absolute; left:calc(50% + 150px); top:86px; transform:translateX(-50%) rotate(-3deg);
      font-family:"Bangers"; font-size:clamp(22px,4.5vw,36px); color:#FF0033; text-shadow:0 3px #fff, 3px 3px #111;
      user-select:none; pointer-events:none; white-space:nowrap; opacity:0; transition:opacity .08s ease, transform .08s ease;
    }
    .scream .shout{ opacity:1; transform:translateX(-50%) }

    .egg, .chickAA{
      position:absolute; will-change:transform,opacity; filter:drop-shadow(0 2px 2px rgba(0,0,0,.15));
      pointer-events:none; z-index:3;
    }
    .egg{ top:-44px; font-size:32px }
    @keyframes fall{
      0%{ transform:translate(var(--x,0), -44px) rotate(0deg); opacity:0 }
      8%{ opacity:1 } 92%{ transform:translate(var(--x,0), 260px) rotate(340deg) }
      100%{ transform:translate(var(--x,0), 265px) rotate(360deg); opacity:.98 }
    }
    @keyframes chickPop{ 0%{ transform:translateY(28px); opacity:0 } 35%{ transform:translateY(-4px); opacity:1 } 100%{ transform:translateY(16px); opacity:0 } }
    @keyframes chickFall{ 0%{ transform:translateY(-40px) rotate(-25deg); opacity:0 } 15%{ opacity:1 } 100%{ transform:translateY(220px) rotate(25deg); opacity:.98 } }

    .miniAA{ position:absolute; font-weight:900; font-size:14px; color:#e11; text-shadow:0 1px 0 #fff,1px 1px 0 rgba(0,0,0,.14); opacity:0; z-index:4 }
    @keyframes aaPop{ 0%{transform:translateY(0) scale(.8);opacity:0} 30%{opacity:1} 100%{transform:translateY(-8px) scale(1.06);opacity:0} }

    .cta{
      position:relative; display:inline-block; margin-top:22px; padding:1.05rem 1.35rem;
      background:var(--yellow); color:#111; text-decoration:none;
      border:4px solid #FF0033; border-radius:16px;
      box-shadow:0 8px 0 #111, 0 12px 24px rgba(0,0,0,.25);
      transform:translateY(0);
      font-family:"Bangers"; font-size:clamp(16px,3.6vw,26px); letter-spacing:.02em;
      transition:transform .08s ease, box-shadow .08s ease, filter .12s ease; overflow:visible;
    }
    .cta::after{
      content:""; position:absolute; inset:-6px; border-radius:inherit; pointer-events:none;
      box-shadow:0 0 0 0 rgba(255,0,51,.34); animation:btnPulse 2.2s ease-out infinite;
    }
    @keyframes btnPulse{ 0%{box-shadow:0 0 0 0 rgba(255,0,51,.34)} 70%{box-shadow:0 0 0 18px rgba(255,0,51,0)} 100%{box-shadow:0 0 0 0 rgba(255,0,51,0)} }
    .cta:hover{ filter:saturate(1.1) }
    .cta:active{ transform:translateY(2px); box-shadow:0 6px 0 #111 }

    .disclaimers{ margin:14px auto 0; max-width:680px; list-style:none; padding:0; color:#333; font-weight:700; font-size:clamp(12px,2.6vw,14px) }
    .disclaimers li{ margin:.25rem 0 }

    .measure{position:absolute; left:0; right:0; top:0; height:6px; background:rgba(0,0,0,.06)}
    .bar{position:absolute; left:0; top:0; bottom:0; width:0; background:linear-gradient(90deg,#ff8a8a 0 60%, #88c7ff 60% 100%); border-bottom-right-radius:6px}
    .playing .bar{ animation:measure 5s linear infinite }
    @keyframes measure{from{width:0} to{width:100%}}

    .controls{ display:none; gap:10px; justify-content:center; margin:16px 0 0 }
    .controls .btn{ border:3px solid #111; background:#fff; padding:.6rem .9rem; border-radius:12px; font-weight:900; cursor:pointer }
    .controls .btn:active{ transform:translateY(1px) }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); backdrop-filter:blur(3px);
      align-items:center; justify-content:center; z-index:100 }
    .modal:target{ display:flex }
    .sheet{
      width:min(520px,92vw); background:#fff; border:4px solid #111; border-radius:22px; padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.45); text-align:center;
    }
    .paybtn{
      display:block; margin:12px 0 0; padding:12px 14px; border-radius:12px; color:#fff; text-decoration:none;
      font-weight:900; background:#635bff;
    }
    .close{
      display:inline-block; margin-top:12px; padding:.6rem .9rem; border:3px solid #111; border-radius:12px;
      background:#f3f3f3; text-decoration:none; color:#111; font-weight:900;
    }

    /* >>> NEW: stato disabled per il bottone EGGSplosion */
    .btn[disabled]{
      opacity:.55; cursor:not-allowed; filter:grayscale(.3);
    }
  </style>
</head>
<body>
  <main class="hero">
    <section class="card" aria-labelledby="title">
      <span class="tag">TURN UP THE SCREECH</span>
      <h1 id="title">$1 • MAKE IT SCREAM</h1>
      <p class="sub">The cheapest scream therapy on the web.</p>

      <div class="stage" id="stage" aria-hidden="true">
        <div class="measure"><div class="bar"></div></div>
        <div class="spark s1">⭐</div><div class="spark s2">⭐</div>
        <div class="spark s3">⭐</div><div class="spark s4">⭐</div>

        <div class="chicken">
          <svg viewBox="0 0 260 210" aria-hidden="true">
            <g class="body">
              <ellipse cx="140" cy="135" rx="95" ry="72" fill="#fff" stroke="#111" stroke-width="5"/>
              <ellipse cx="140" cy="150" rx="70" ry="46" fill="#fefefe" stroke="#0000"/>
            </g>
            <ellipse class="wing" cx="110" cy="135" rx="40" ry="28" fill="#fff" stroke="#111" stroke-width="4"/>
            <circle class="eye" cx="170" cy="105" r="7" fill="#111"/>
            <path class="crest" d="M150 75 C155 55,175 50,180 70 C186 50,205 52,202 72 C195 56,176 58,170 77 Z"
                  fill="#FF0033" stroke="#111" stroke-width="4"/>
            <g fill="#ffb628" stroke="#111" stroke-width="4">
              <path class="beak-upper" d="M182 120 L225 110 L182 104 Z"/>
              <path class="beak-lower" d="M182 121 L226 134 L182 127 Z"/>
            </g>
            <path d="M120 198 l0-28 M160 198 l0-28" stroke="#111" stroke-width="6" />
          </svg>
          <div class="shout">AAA!!!</div>
        </div>
      </div>

      <a class="cta" href="#pay">💥🐔🥚 $1 MAKE IT SCREAM — PLAY THE BEAT 💥🐔🥚</a>

      <ul class="disclaimers" aria-label="disclaimers">
        <li>No refunds. Only scream.</li>
        <li>Volume HIGHLY recommended.</li>
        <li>As American as fried chicken at 3 AM.</li>
      </ul>

      <div class="controls" id="controls">
        <button id="startBtn" class="btn">🔊 Start Beat</button>
        <button id="stopBtn"  class="btn" style="display:none">🛑 Stop</button>
        <button id="eggBtn"   class="btn" title="Unleash the chaos">🥚💥 EGGSplosion</button>
      </div>
    </section>
  </main>

  <div id="pay" class="modal" onclick="location.hash=''">
    <div class="sheet" onclick="event.stopPropagation()">
      <h3 style="font-family:'Bangers'; font-size:28px; margin:0 0 .25rem">INSERT $1</h3>
      <p style="margin:.25rem 0 .5rem"><strong>→ instant screech therapy.</strong></p>
      <a class="paybtn" href="?success=1#close" target="_self" rel="noopener">Pay with Stripe</a>
      <a class="close" href="#">Cancel</a>
    </div>
  </div>

 <script>
/* ===== AUDIO + VISUAL ENGINE — sync-lock + mobile clean ===== */
(function(){
  const stage    = document.getElementById('stage');
  const bar      = stage.querySelector('.bar');
  const controls = document.getElementById('controls');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const eggBtn   = document.getElementById('eggBtn');
  const chicken  = stage.querySelector('.chicken');
  const crestEl  = stage.querySelector('.crest');

  const IS_MOBILE = (('maxTouchPoints' in navigator && navigator.maxTouchPoints > 0) ||
                    (window.matchMedia && window.matchMedia('(pointer:coarse)').matches));

  /* -------- Profiles: desktop “brutale pulito” vs mobile “pulito massimo” -------- */
  const PROF = IS_MOBILE ? {
    LOOKAHEAD: 0.28,              // audio scheduler anticipo
    TICK_MS:   30,                // frequenza scheduler
    VOICE_BUDGET: 34,             // budget totale voci (mobile)
    EGG_POOL: 56,                 // più ampio per non “sparire”
    MINI_AA_COOLDOWN_MS: 80,
    SWING: 0.03,
    // EGGSplosion (mobile, più safe)
    BURST_COOLDOWN_MS: 4500,      // ricarica più lunga per evitare sovrapposizioni
    BURST_WAVES: 2,
    BURST_STEP: 0.022,
    BURST_EGGS_PER_WAVE: 14,
  } : {
    LOOKAHEAD: 0.42,
    TICK_MS:   20,
    VOICE_BUDGET: 180,
    EGG_POOL: 72,
    MINI_AA_COOLDOWN_MS: 34,
    SWING: 0.04,
    // EGGSplosion (desktop, ignorante ma pulito)
    BURST_COOLDOWN_MS: 2400,
    BURST_WAVES: 4,
    BURST_STEP: 0.014,
    BURST_EGGS_PER_WAVE: 28,
  };

  // mostra controlli post-pagamento
  const url = new URL(location.href);
  if (url.searchParams.get('success') === '1') controls.style.display = 'flex';
  chicken.classList.add('breathe');

  /* ---------------- Audio chain ---------------- */
  let ctx=null, master, preSat, comp, postLP, softLim, NOISE_BUF=null;

  function ac(){
    if (!ctx || ctx.state === 'closed'){
      ctx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
    }
    return ctx;
  }

  // voice accounting corretto
  let VOICES_NOW = 0;
  const inc=()=>{ VOICES_NOW++; };
  const dec=()=>{ VOICES_NOW = Math.max(0, VOICES_NOW-1); };
  function track(node, fallbackMs=300){
    inc();
    const tidy=()=>{ node.removeEventListener?.('ended', tidy); dec(); };
    try{ node.addEventListener?.('ended', tidy, {once:true}); }catch(e){}
    setTimeout(tidy, fallbackMs+30);
  }
  const headroom = ()=> Math.max(0, PROF.VOICE_BUDGET - VOICES_NOW);

  function mkWS(curveFn, n=4096){
    const c=ac(); const curve=new Float32Array(n);
    for (let i=0;i<n;i++){ const x=i/n*2-1; curve[i]=curveFn(x); }
    const ws=c.createWaveShaper(); ws.curve=curve; ws.oversample='4x'; return ws;
  }

  function buildMaster(){
    const c=ac();
    master = c.createGain();

    // Mobile: meno drive, più headroom. Desktop: più spinta ma morbida.
    preSat = mkWS(x => Math.tanh((IS_MOBILE?7.5:9.5)*x));
    comp   = c.createDynamicsCompressor();
    comp.threshold.value = IS_MOBILE ? -14 : -12;
    comp.knee.value      = IS_MOBILE ? 16  : 12;
    comp.ratio.value     = IS_MOBILE ? 6   : 5;
    comp.attack.value    = 0.004;
    comp.release.value   = 0.12;

    // Post low-pass per togliere fruscio aspro su mobile, lascia aria su desktop
    postLP = c.createBiquadFilter();
    postLP.type='lowpass';
    postLP.frequency.value = IS_MOBILE ? 3800 : 5200;
    postLP.Q.value = 0.5;

    // Soft limiter (clipper morbido)
    softLim = mkWS(x => {
      const k=0.92; return Math.max(-k, Math.min(k, x));
    });

    master.connect(preSat).connect(comp).connect(postLP).connect(softLim).connect(c.destination);

    const now=c.currentTime+0.001;
    master.gain.setValueAtTime(IS_MOBILE?1.00:1.06, now);

    if (!NOISE_BUF){
      NOISE_BUF = c.createBuffer(1, Math.floor(c.sampleRate*1.0), c.sampleRate);
      const d = NOISE_BUF.getChannelData(0);
      for (let i=0;i<d.length;i++) d[i]=(Math.random()*2-1);
    }
  }
  function ensureMaster(){
    const c=ac();
    if (!master || master.context!==c) buildMaster();
    if (c.state!=='running' && c.resume){ try{c.resume();}catch(e){} }
    return c;
  }
  // mobile unlock
  function unlockOnce(){
    const c=ensureMaster();
    try{
      const src=c.createBufferSource(); src.buffer=c.createBuffer(1,1,c.sampleRate);
      src.connect(c.destination); src.start(0); track(src, 20);
    }catch(e){}
    document.removeEventListener('pointerdown', unlockOnce);
    document.removeEventListener('touchstart', unlockOnce);
  }
  document.addEventListener('pointerdown', unlockOnce, {passive:true, once:true});
  document.addEventListener('touchstart',  unlockOnce, {passive:true, once:true});
  document.addEventListener('visibilitychange', () => {
    if (!ctx) return; if (document.visibilityState==='visible' && ctx.state!=='running') ctx.resume?.();
  });

  /* ---------------- VISUAL QUEUE (Audio-locked) ----------------
     Tutte le animazioni visual vengono accodate con un time (ctx.currentTime).
     Un loop RAF legge currentTime e spara gli eventi “due” → sync perfetto.  */
  const vq = []; // {t, fn}
  function at(t, fn){ vq.push({t, fn}); } // schedule visual @ audio time
  function runVQ(){
    const c=ac(); const now=c.currentTime;
    // esegui max 32 per frame per non bloccare
    let executed=0;
    for (let i=vq.length-1; i>=0 && executed<32; i--){
      if (vq[i].t <= now){
        const ev=vq.splice(i,1)[0]; try{ ev.fn(); }catch(e){}
        executed++;
      }
    }
    requestAnimationFrame(runVQ);
  }
  requestAnimationFrame(runVQ);

  /* ---------------- Visual helpers (agganciati a VQ) ---------------- */
  function setScream(on){
    stage.classList.toggle('scream', !!on);
    const shoutEl = stage.querySelector('.shout');
    if (shoutEl){ shoutEl.style.opacity = on ? '1' : '0'; shoutEl.style.transform='translateX(-50%)'; }
  }
  function pulseWingAt(t){ at(t, ()=>{ stage.classList.add('beat'); setTimeout(()=>stage.classList.remove('beat'), 150); }); }
  function pumpChickenAt(t){ at(t, ()=>{ chicken.classList.remove('pump'); void chicken.offsetWidth; chicken.classList.add('pump'); crestEl?.classList.remove('bob'); void crestEl?.offsetWidth; crestEl?.classList.add('bob'); }); }
  function thumpAt(t){ at(t, ()=>{ stage.style.transform='scale(1.012)'; setTimeout(()=>stage.style.transform='scale(1)', 90); }); }

  /* ---------------- Egg pool ---------------- */
  const eggPool=[];
  function initEggPool(){
    if (eggPool.length) return;
    for (let i=0;i<PROF.EGG_POOL;i++){
      const e=document.createElement('span');
      e.className='egg'; e.textContent='🥚'; e.style.display='none';
      stage.appendChild(e); eggPool.push(e);
    }
  }
  function getEgg(){
    for (const e of eggPool) if (e.style.display==='none'){ e.style.display=''; return e; }
    // Se tutte occupate, droppa visual meno importanti su mobile per restare fluidi
    if (IS_MOBILE) return null;
    const e=eggPool[0]; e.style.display=''; return e;
  }
  function releaseEgg(e){ if(!e) return; e.style.display='none'; e.textContent='🥚'; e.style.animation='none'; void e.offsetWidth; }

  let lastAATime=0;
  function miniAAnear(e){
    if(!e) return;
    const now=performance.now(); if (now-lastAATime<PROF.MINI_AA_COOLDOWN_MS) return;
    lastAATime=now;
    const aa=document.createElement('span'); aa.className='miniAA'; aa.textContent='aa';
    const r=e.getBoundingClientRect(), rs=stage.getBoundingClientRect();
    aa.style.left = (r.left-rs.left+18)+'px';
    aa.style.top  = (r.top -rs.top -12)+'px';
    stage.appendChild(aa); aa.style.animation='aaPop .24s ease-out forwards';
    setTimeout(()=>aa.remove(), 260);
  }

  /* ---------------- Drum & Voices ---------------- */
  function hat(t, out, gain=0.42, open=false){
    const c=ac();
    const src=c.createBufferSource(); src.buffer=NOISE_BUF;
    const hp=c.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=open?3000:5000;
    const g=c.createGain(); const len=open?0.14:0.06;
    g.gain.setValueAtTime(gain, t); g.gain.exponentialRampToValueAtTime(0.0001, t+len);
    src.connect(hp).connect(g).connect(out); src.start(t); src.stop(t+len+0.005); track(src, len*1000);
  }
  function kick(t, out){
    const c=ac(); const o=c.createOscillator(); o.type='sine';
    const g=c.createGain(); o.frequency.setValueAtTime(140,t); o.frequency.exponentialRampToValueAtTime(55,t+0.16);
    g.gain.setValueAtTime(1.0,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.18);
    o.connect(g).connect(out); o.start(t); o.stop(t+0.19); track(o, 190);
  }
  function snare(t, out, ghost=false){
    const c=ac(); const o=c.createOscillator(); o.type='square';
    const g=c.createGain(); o.frequency.setValueAtTime(ghost?680:760,t); o.frequency.exponentialRampToValueAtTime(300,t+0.07);
    g.gain.setValueAtTime(ghost?0.45:0.95,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.10);
    o.connect(g).connect(out); o.start(t); o.stop(t+0.11); track(o, 120);
  }
  function mkDist(amt=IS_MOBILE?14:18){ return mkWS(x=>Math.tanh(amt*x)); }

  function babyAA(t, out, {
    len=IS_MOBILE?0.28:0.32, pitch=1.6, gain=IS_MOBILE?0.50:0.58, detCents=10, tremHz=IS_MOBILE?12:14,
    distAmt=IS_MOBILE?12:16, voices=IS_MOBILE?1:2, cluster=IS_MOBILE?1:2, clusterGap=0.035
  }={}){
    if (headroom()<3){ voices=1; cluster=1; gain*=0.6; len*=0.7; }
    const c=ac();
    for (let k=0;k<cluster;k++){
      const tt=t+k*clusterGap;
      const bus=c.createGain(); bus.gain.setValueAtTime(0.0001,tt);
      bus.gain.exponentialRampToValueAtTime(gain,tt+0.02);
      bus.gain.exponentialRampToValueAtTime(0.0001,tt+len);

      const dist=mkDist(distAmt), bp=c.createBiquadFilter(), lp=c.createBiquadFilter();
      bp.type='bandpass'; bp.frequency.value=IS_MOBILE?1900:2100; bp.Q.value=4.5;
      lp.type='lowpass';  lp.frequency.value=IS_MOBILE?3200:3600;

      const sum=c.createGain(); sum.connect(dist).connect(bp).connect(lp).connect(bus).connect(out);

      for (let v=0; v<voices; v++){
        if (headroom()<=0) break;
        const o=c.createOscillator(); o.type='sawtooth';
        const g=c.createGain(); const f0=620*pitch;
        o.frequency.setValueAtTime(f0,tt);
        o.detune.setValueAtTime(v===0?-detCents:+detCents,tt);
        o.frequency.linearRampToValueAtTime(f0*1.14, tt+0.05);
        o.frequency.exponentialRampToValueAtTime(f0*0.28, tt+len*0.85);
        g.gain.setValueAtTime(0.0001,tt);
        g.gain.exponentialRampToValueAtTime(0.92,tt+0.035);
        g.gain.exponentialRampToValueAtTime(0.0001,tt+len);
        const trem=c.createOscillator(); trem.frequency.value=tremHz;
        const tremAmt=c.createGain(); trem.connect(tremAmt.gain); g.connect(tremAmt);
        o.connect(g).connect(sum); trem.start(tt); trem.stop(tt+len); o.start(tt); o.stop(tt+len);
        track(o, len*1000);
      }

      // noise layer
      if (headroom()>0){
        const n=c.createBufferSource(); n.buffer=NOISE_BUF;
        const nBP=c.createBiquadFilter(); nBP.type='bandpass'; nBP.frequency.value=2300; nBP.Q.value=6;
        const ng=c.createGain(); ng.gain.setValueAtTime(0.001, tt+0.03);
        ng.gain.exponentialRampToValueAtTime(0.22, tt+0.08);
        ng.gain.exponentialRampToValueAtTime(0.0001, tt+len);
        n.connect(nBP).connect(ng).connect(sum); n.start(tt); n.stop(tt+len); track(n, len*1000);
      }
    }
  }

  /* ---------------- Eggs visual, audio-locked ---------------- */
  const LANES=[12,31,50,69,88];
  function scheduleEgg(lanePct, t, hatchMode){ // t in audio time
    at(t, ()=>{
      const e=getEgg(); if(!e) return; // su mobile, se saturo, salta
      const size=30+Math.round(Math.random()*8);
      e.style.fontSize=size+'px'; e.style.left=`calc(${lanePct}% - ${size/2}px)`;
      e.style.setProperty('--x', (Math.random()*8-4)+'px');
      e.style.animation='none'; void e.offsetWidth; e.style.animation='fall 1.12s linear forwards';
      if (hatchMode){
        const delay = (hatchMode==='air')?0.48:1.08;
        at(ac().currentTime + delay, ()=>{
          e.textContent='🐣'; miniAAnear(e);
          babyAA(ac().currentTime+0.005, master, {cluster:IS_MOBILE?1:2, voices:IS_MOBILE?1:2, pitch:(hatchMode==='air'?1.65:1.55)});
        });
      }
      setTimeout(()=>releaseEgg(e), 1500);
    });
  }

  /* ---------------- Scream main (3s) ---------------- */
  function scream3s(t, out){
    const c=ac(); const len=3.0;
    at(t, ()=>setScream(true));
    const bus=c.createGain(); const dist=mkDist(IS_MOBILE?14:18);
    const bp=c.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=4.5;
    const lp=c.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=IS_MOBILE?2700:3000;
    bus.connect(dist).connect(bp).connect(lp).connect(out);

    [-10,+10].forEach(det=>{
      const o=c.createOscillator(); o.type='sawtooth';
      const g=c.createGain(); o.frequency.setValueAtTime(620,t); o.detune.setValueAtTime(det,t);
      o.frequency.linearRampToValueAtTime(720,t+0.12); o.frequency.exponentialRampToValueAtTime(160,t+len*0.92);
      g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.90,t+0.06); g.gain.exponentialRampToValueAtTime(0.0001,t+len);
      const trem=c.createOscillator(); trem.frequency.value=IS_MOBILE?12:13;
      const tremAmt=c.createGain(); trem.connect(tremAmt.gain); g.connect(tremAmt);
      o.connect(g).connect(bus); trem.start(t); trem.stop(t+len); o.start(t); o.stop(t+len); track(o, len*1000);
    });

    const n=c.createBufferSource(); n.buffer=NOISE_BUF;
    const nBP=c.createBiquadFilter(); nBP.type='bandpass'; nBP.frequency.value=IS_MOBILE?2400:2600; nBP.Q.value=6;
    const ng=c.createGain(); ng.gain.setValueAtTime(0.04,t+0.08); ng.gain.exponentialRampToValueAtTime(0.45,t+0.22); ng.gain.exponentialRampToValueAtTime(0.0001,t+len);
    n.connect(nBP).connect(ng).connect(bus); n.start(t); n.stop(t+len); track(n, len*1000);

    for (let x=t+0.10; x<t+len-0.06; x+=0.25){
      hat(x,out,0.18,false);
      const lane = (Math.round((x - t)/0.25) % 2) ? 31 : 50;
      scheduleEgg(lane, x, null);
    }
    at(t+len+0.06, ()=>setScream(false));
    return t+len;
  }

  /* ---------------- Beat (2s) con variazioni leggere ---------------- */
  let measureIdx=0;
  function scheduleMeasure(start,out){
    const dur=2.0, beat=0.5;
    const ghostOn = (measureIdx%2===1) && Math.random()<0.6;
    const openHatOn = Math.random()<0.25;
    const fillOn = (measureIdx%4===3);

    for (let i=0;i<4;i++){
      const t = start + i*beat;
      pulseWingAt(t); pumpChickenAt(t);
      if (i===0 || i===2){ kick(t,out); thumpAt(t); } else { snare(t,out, ghostOn && i===3); }
      hat(t,out,0.40, openHatOn && i===3);

      const hatchP = [0.14,0.24,0.16,0.28][i] + (fillOn?0.06:0);
      const hatch = (Math.random()<hatchP) ? (Math.random()<0.5?'air':'ground') : null;
      scheduleEgg([12,69,31,88][i], t, hatch);

      const off = t + beat/2 + (PROF.SWING*beat);
      hat(off,out,0.38,false);
      const hatch2 = (Math.random()<0.20) ? (Math.random()<0.5?'air':'ground') : null;
      scheduleEgg([50,31,50,69][i], off, hatch2);

      // mini AA legati all’off-beat (audio-locked)
      if (Math.random()<0.82) babyAA(off, out, {cluster: fillOn? (IS_MOBILE?1:3):(IS_MOBILE?1:2)});
    }
    if (fillOn){ const t=start+1.75; snare(t,out,false); hat(t+0.10,out,0.34,true); }
    measureIdx++; return start+dur;
  }

  /* ---------------- Transient & Duck ---------------- */
  function transient(mult=1){
    const c=ac(); if(!master) return; const base=IS_MOBILE?1.00:1.06; const now=c.currentTime+0.001;
    master.gain.cancelScheduledValues(now);
    master.gain.setValueAtTime(base, now);
    master.gain.linearRampToValueAtTime(base*(1.08*mult), now+0.02);
    master.gain.linearRampToValueAtTime(base, now+0.12);
  }
  function duck(amount=0.86, hold=0.22){
    const c=ac(); if(!master) return; const base=IS_MOBILE?1.00:1.06; const now=c.currentTime+0.001;
    master.gain.cancelScheduledValues(now);
    master.gain.setValueAtTime(base, now);
    master.gain.linearRampToValueAtTime(base*amount, now+0.01);
    master.gain.linearRampToValueAtTime(base, now+hold);
  }

  /* ---------------- Loop scheduler ---------------- */
  let isRunning=false, schedTimer=null, timelineEnd=0;
  function chunk(from){
    const after = scream3s(from, master);
    scheduleMeasure(after+0.06, master);
    return from+5.0;
  }
  function tick(){
    if (!isRunning) return;
    const c=ac(); const horizon=c.currentTime + PROF.LOOKAHEAD;
    while (timelineEnd < horizon){
      stage.classList.add('playing');
      bar.style.animation='none'; bar.offsetHeight; bar.style.animation=null;
      timelineEnd = chunk(timelineEnd || (c.currentTime+0.08));
    }
  }
  function startLoop(){
    ensureMaster(); initEggPool(); isRunning=true; timelineEnd=0; measureIdx=0;
    if (schedTimer) clearInterval(schedTimer);
    schedTimer=setInterval(tick, PROF.TICK_MS);
    transient(1.03);
    bar.style.animation='none'; bar.offsetHeight; bar.style.animation=null;
    startBtn.style.display='none'; stopBtn.style.display='inline-block';
  }
  function stopLoop(){
    if (!isRunning) return; isRunning=false;
    if (schedTimer){ clearInterval(schedTimer); schedTimer=null; }
    const c=ac(); const now=c.currentTime;
    try{ master.gain.cancelScheduledValues(now); master.gain.setValueAtTime(master.gain.value, now); master.gain.linearRampToValueAtTime(0.0001, now+0.10); }catch(e){}
    stage.classList.remove('playing'); setScream(false);
    startBtn.style.display='inline-block'; stopBtn.style.display='none';
  }

  /* ---------------- EGGSplosion (desktop brutale, mobile safe) ---------------- */
  let burstLocked=false, queuedBursts=0;
  function burst(){
    const c=ensureMaster(); initEggPool();
    duck(IS_MOBILE?0.84:0.80, IS_MOBILE?0.26:0.34);
    transient(1.12);

    const base=c.currentTime+0.02;
    const waves=PROF.BURST_WAVES, step=PROF.BURST_STEP;
    const eggsPer = PROF.BURST_EGGS_PER_WAVE + Math.min(queuedBursts,4)* (IS_MOBILE?3:5);

    for (let w=0; w<waves; w++){
      const wBase = base + w*0.32;
      for (let i=0;i<eggsPer;i++){
        const t = wBase + i*step;
        const lane = LANES[(i+w*3)%LANES.length];
        const mode = (Math.random()<0.74?'air':'ground');
        scheduleEgg(lane, t, mode);
        if (headroom() >= (IS_MOBILE?5:8)){
          const cl = headroom() > (IS_MOBILE?18:24) ? (IS_MOBILE?1:3) : 2;
          babyAA(t+0.010, master, {cluster:cl, voices:IS_MOBILE?1:2, pitch:1.55 + Math.random()*0.2});
        }
      }
    }
    queuedBursts=0;
  }
  function triggerBurst(){
    if (burstLocked) return;
    burstLocked=true;
    // UI countdown
    if (eggBtn){
      eggBtn.disabled=true;
      const txt=eggBtn.textContent; let left=Math.ceil(PROF.BURST_COOLDOWN_MS/1000);
      eggBtn.textContent=`🥚💥 EGGSplosion (${left})`;
      const it=setInterval(()=>{ left--; eggBtn.textContent=`🥚💥 EGGSplosion (${left})`; if(left<=0){ clearInterval(it); eggBtn.disabled=false; eggBtn.textContent=txt; }},1000);
    }
    queuedBursts++; requestAnimationFrame(burst);
    setTimeout(()=>{ burstLocked=false; }, PROF.BURST_COOLDOWN_MS);
  }

  /* ---------------- Wire buttons ---------------- */
  if (startBtn){
    startBtn.addEventListener('pointerdown', startLoop, {passive:true});
    stopBtn .addEventListener('pointerdown',  stopLoop, {passive:true});
    eggBtn  .addEventListener('pointerdown',  triggerBurst, {passive:true});
    startBtn.addEventListener('pointerdown', ensureMaster, {passive:true, once:true});
    eggBtn  .addEventListener('pointerdown', ensureMaster, {passive:true, once:true});
  }
})();
</script>

</body>
</html>











































































