<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EggScream — $1 Make It Scream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="canonical" href="https://www.eggscream.com/">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --yellow:#FFD600; --red:#FF0033; --blue:#0066FF; --offwhite:#FFF8E1; --ink:#0f0f0f;
      --line:#f0dede;
    }
    html,body{margin:0;background:var(--offwhite);color:var(--ink)}
    body{font:16px/1.4 "Comic Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}

    /* --- Hero full bleed con strisce oblique --- */
    .hero{
      min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:48px 18px;
      background:
        repeating-linear-gradient(135deg,#fff 0 24px,#ffecec 24px 48px),
        linear-gradient(var(--offwhite),var(--offwhite));
    }
    .card{
      width:min(980px,94vw); text-align:center; background:#fff;
      border:4px solid #111; border-radius:26px; padding:36px 28px;
      box-shadow:0 28px 60px rgba(0,0,0,.25);
    }

    /* Badge/tag sopra il bottone */
    .tag{
      display:inline-block; background:#fff; border:4px solid #111; border-radius:999px;
      padding:.35rem .8rem; font-family:"Bangers", system-ui; letter-spacing:.02em; font-size:clamp(14px,2.6vw,18px);
    }

    h1{
      font-family:"Bangers", system-ui; text-transform:uppercase; letter-spacing:.02em;
      margin:.6rem 0 .25rem; line-height:1.02; font-size:clamp(40px,8.5vw,96px);
    }
    .sub{ margin:.25rem 0 0; font-weight:700; font-size:clamp(16px,3.2vw,22px); }

    /* Gallina gigante / STAGE */
    .stage{
      position:relative; margin:24px auto 0; height:320px; border:3px dashed var(--line); border-radius:22px;
      display:flex; align-items:center; justify-content:center; background:linear-gradient(#fff,#fafafa); overflow:hidden;
      transition:transform .08s ease; will-change:transform;
    }
    .spark{ position:absolute; font-size:26px; opacity:.22; animation:pop 1.2s infinite }
    .spark.s1{ left:14%; top:22% } .spark.s2{ right:12%; top:18% } .spark.s3{ left:10%; bottom:14% } .spark.s4{ right:8%; bottom:12% }
    @keyframes pop{ 0%,100%{ transform:scale(1) rotate(0) } 50%{ transform:scale(1.2) rotate(10deg) } }

    /* >>> PATCH: centratura reale + origin coerente <<< */
    .chicken{
      width:min(360px,76vw);
      transform:rotate(-4deg);
      transform-origin:center center;
      position:relative;
      margin:0 auto; /* centra nello stage */
      will-change:transform;
    }

    /* ---- VITA DEL POLLO ---- */
    /* Occhio blink */
    .eye{ animation:eyeBlink 4.2s infinite; transform-origin:170px 105px }
    @keyframes eyeBlink{ 0%,96%,100%{ transform:scaleY(1) } 98%{ transform:scaleY(.1) } }

    /* Cresta viva (idle + durante scream) */
    .crest{ transform-origin:170px 82px; animation:crestBlink .9s steps(2,end) infinite }
    @keyframes crestBlink{ 0%,100%{ fill:var(--red) } 50%{ fill:var(--blue) } }
    .scream .crest{ animation:crestSway .18s ease-in-out infinite }
    @keyframes crestSway{ 0%{transform:rotate(0)} 50%{transform:rotate(-7deg)} 100%{transform:rotate(0)} }

    /* Becco */
    .beak-upper,.beak-lower{ transform-origin:182px 120px; transition:transform .08s ease }
    .scream .beak-upper{ transform:rotate(-22deg) translateY(-2px) }
    .scream .beak-lower{ transform:rotate(22deg) translateY(6px) }

    /* Ala “pompa” a tempo */
    .wing{ transform-origin:125px 125px }
    .beat .wing{ animation:flap .24s ease-out }
    @keyframes flap{ 0%{transform:rotate(0)} 50%{transform:rotate(-8deg)} 100%{transform:rotate(0)} }

    /* >>> PATCH: respiro + pump senza translateX <<< */
    .chicken.breathe { animation: chickenBreathe 3s ease-in-out infinite }
    @keyframes chickenBreathe {
      0%,100%{ transform:rotate(-4deg) scale(1) }
      50%    { transform:rotate(-4deg) scale(1.01) }
    }
    .chicken.pump { animation: chickenPump .12s ease-out 1 }
    @keyframes chickenPump {
      0%   { transform: rotate(-4deg) }
      50%  { transform: rotate(-4.6deg) }
      100% { transform: rotate(-4deg) }
    }
    .crest.bob { animation: crestBob .12s ease-out 1; transform-origin:170px 82px }
    @keyframes crestBob { 0%{transform:rotate(0)} 50%{transform:rotate(-7deg)} 100%{transform:rotate(0)} }

    /* AAA fisso vicino al becco */
    .shout{
      position:absolute; left:calc(50% + 150px); top:86px; transform:translateX(-50%) rotate(-3deg);
      font-family:"Bangers"; font-size:clamp(22px,4.5vw,36px); color:#FF0033; text-shadow:0 3px #fff, 3px 3px #111;
      user-select:none; pointer-events:none; white-space:nowrap; opacity:0; transition:opacity .08s ease, transform .08s ease;
    }
    .scream .shout{ opacity:1; transform:translateX(-50%) }

    /* Emoji uova che cadono + schiusa */
    .egg, .chickAA{
      position:absolute; will-change:transform,opacity; filter:drop-shadow(0 2px 2px rgba(0,0,0,.15));
      pointer-events:none; z-index:3;
    }
    .egg{ top:-44px; font-size:32px }
    @keyframes fall{
      0%{ transform:translate(var(--x,0), -44px) rotate(0deg); opacity:0 }
      8%{ opacity:1 } 92%{ transform:translate(var(--x,0), 260px) rotate(340deg) }
      100%{ transform:translate(var(--x,0), 265px) rotate(360deg); opacity:.98 }
    }
    @keyframes chickPop{ 0%{ transform:translateY(28px); opacity:0 } 35%{ transform:translateY(-4px); opacity:1 } 100%{ transform:translateY(16px); opacity:0 } }
    @keyframes chickFall{ 0%{ transform:translateY(-40px) rotate(-25deg); opacity:0 } 15%{ opacity:1 } 100%{ transform:translateY(220px) rotate(25deg); opacity:.98 } }

    /* mini “aa” vicino alla schiusa */
    .miniAA{ position:absolute; font-weight:900; font-size:14px; color:#e11; text-shadow:0 1px 0 #fff,1px 1px 0 rgba(0,0,0,.14); opacity:0; z-index:4 }
    @keyframes aaPop{ 0%{transform:translateY(0) scale(.8);opacity:0} 30%{opacity:1} 100%{transform:translateY(-8px) scale(1.06);opacity:0} }

    /* Pulsantone giallo + pulse rosso ogni ~2s */
    .cta{
      position:relative; display:inline-block; margin-top:22px; padding:1.05rem 1.35rem;
      background:var(--yellow); color:#111; text-decoration:none;
      border:4px solid #FF0033; border-radius:16px;
      box-shadow:0 8px 0 #111, 0 12px 24px rgba(0,0,0,.25);
      transform:translateY(0);
      font-family:"Bangers"; font-size:clamp(16px,3.6vw,26px); letter-spacing:.02em;
      transition:transform .08s ease, box-shadow .08s ease, filter .12s ease; overflow:visible;
    }
    .cta::after{
      content:""; position:absolute; inset:-6px; border-radius:inherit; pointer-events:none;
      box-shadow:0 0 0 0 rgba(255,0,51,.34); animation:btnPulse 2.2s ease-out infinite;
    }
    @keyframes btnPulse{ 0%{box-shadow:0 0 0 0 rgba(255,0,51,.34)} 70%{box-shadow:0 0 0 18px rgba(255,0,51,0)} 100%{box-shadow:0 0 0 0 rgba(255,0,51,0)} }
    .cta:hover{ filter:saturate(1.1) }
    .cta:active{ transform:translateY(2px); box-shadow:0 6px 0 #111 }

    /* Disclaimer */
    .disclaimers{ margin:14px auto 0; max-width:680px; list-style:none; padding:0; color:#333; font-weight:700; font-size:clamp(12px,2.6vw,14px) }
    .disclaimers li{ margin:.25rem 0 }

    /* Barra di progresso sottile (sopra stage, opzionale) */
    .measure{position:absolute; left:0; right:0; top:0; height:6px; background:rgba(0,0,0,.06)}
    .bar{position:absolute; left:0; top:0; bottom:0; width:0; background:linear-gradient(90deg,#ff8a8a 0 60%, #88c7ff 60% 100%); border-bottom-right-radius:6px}
    .playing .bar{ animation:measure 5s linear infinite }
    @keyframes measure{from{width:0} to{width:100%}}

    /* Controlli post-pagamento (restano invisibili finché non success=1) */
    .controls{ display:none; gap:10px; justify-content:center; margin:16px 0 0 }
    .controls .btn{ border:3px solid #111; background:#fff; padding:.6rem .9rem; border-radius:12px; font-weight:900; cursor:pointer }
    .controls .btn:active{ transform:translateY(1px) }

    /* Modale pagamento */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); backdrop-filter:blur(3px);
      align-items:center; justify-content:center; z-index:100 }
    .modal:target{ display:flex }
    .sheet{
      width:min(520px,92vw); background:#fff; border:4px solid #111; border-radius:22px; padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.45); text-align:center;
    }
    .paybtn{
      display:block; margin:12px 0 0; padding:12px 14px; border-radius:12px; color:#fff; text-decoration:none;
      font-weight:900; background:#635bff;
    }
    .close{
      display:inline-block; margin-top:12px; padding:.6rem .9rem; border:3px solid #111; border-radius:12px;
      background:#f3f3f3; text-decoration:none; color:#111; font-weight:900;
    }
  </style>
</head>
<body>
  <main class="hero">
    <section class="card" aria-labelledby="title">
      <span class="tag">TURN UP THE SCREECH</span>
      <h1 id="title">$1 • MAKE IT SCREAM</h1>
      <p class="sub">The cheapest scream therapy on the web.</p>

      <div class="stage" id="stage" aria-hidden="true">
        <div class="measure"><div class="bar"></div></div>
        <!-- decor “fairground” -->
        <div class="spark s1">⭐</div><div class="spark s2">⭐</div>
        <div class="spark s3">⭐</div><div class="spark s4">⭐</div>

        <!-- gallina -->
        <div class="chicken">
          <svg viewBox="0 0 260 210" aria-hidden="true">
            <g class="body">
              <ellipse cx="140" cy="135" rx="95" ry="72" fill="#fff" stroke="#111" stroke-width="5"/>
              <ellipse cx="140" cy="150" rx="70" ry="46" fill="#fefefe" stroke="#0000"/>
            </g>
            <ellipse class="wing" cx="110" cy="135" rx="40" ry="28" fill="#fff" stroke="#111" stroke-width="4"/>
            <circle class="eye" cx="170" cy="105" r="7" fill="#111"/>
            <path class="crest" d="M150 75 C155 55,175 50,180 70 C186 50,205 52,202 72 C195 56,176 58,170 77 Z"
                  fill="#FF0033" stroke="#111" stroke-width="4"/>
            <g fill="#ffb628" stroke="#111" stroke-width="4">
              <path class="beak-upper" d="M182 120 L225 110 L182 104 Z"/>
              <path class="beak-lower" d="M182 121 L226 134 L182 127 Z"/>
            </g>
            <path d="M120 198 l0-28 M160 198 l0-28" stroke="#111" stroke-width="6" />
          </svg>
          <div class="shout">AAA!!!</div>
        </div>
      </div>

      <a class="cta" href="#pay">💥🐔🥚 $1 MAKE IT SCREAM — PLAY THE BEAT 💥🐔🥚</a>

      <ul class="disclaimers" aria-label="disclaimers">
        <li>No refunds. Only scream.</li>
        <li>Volume HIGHLY recommended.</li>
        <li>As American as fried chicken at 3 AM.</li>
      </ul>

      <!-- Controlli che compaiono post-pagamento -->
      <div class="controls" id="controls">
        <button id="startBtn" class="btn">🔊 Start Beat</button>
        <button id="stopBtn"  class="btn" style="display:none">🛑 Stop</button>
        <button id="eggBtn"   class="btn" title="Unleash the chaos">🥚💥 EGGSplosion</button>
      </div>
    </section>
  </main>

  <!-- Modal pagamento -->
  <div id="pay" class="modal" onclick="location.hash=''">
    <div class="sheet" onclick="event.stopPropagation()">
      <h3 style="font-family:'Bangers'; font-size:28px; margin:0 0 .25rem">INSERT $1</h3>
      <p style="margin:.25rem 0 .5rem"><strong>→ instant screech therapy.</strong></p>
      <a class="paybtn" href="?success=1#close" target="_self" rel="noopener">Pay with Stripe</a>
      <a class="close" href="#">Cancel</a>
    </div>
  </div>

  <script>
  // ===== AUDIO + VISUAL ENGINE (rev. definitive) =====
  (function(){
    const stage    = document.getElementById('stage');
    const bar      = stage.querySelector('.bar');
    const controls = document.getElementById('controls');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const eggBtn   = document.getElementById('eggBtn');
    const chicken  = stage.querySelector('.chicken');
    const crestEl  = stage.querySelector('.crest');

    // --- Flags & Profiles ---
    const IS_MOBILE = (('maxTouchPoints' in navigator && navigator.maxTouchPoints > 0) ||
                      (window.matchMedia && window.matchMedia('(pointer:coarse)').matches));

    // Profili separati
    const PROF = IS_MOBILE ? {
      LOOKAHEAD: 0.28,      // quanto schedulare in anticipo (audio)
      TICK_MS:   35,        // quanto spesso svegliare lo scheduler
      VOICE_BUDGET: 26,     // limite “voci” simultanee
      EGGS_PER_WAVE: 14,
      EGG_POOL: 30,
      MINI_AA_COOLDOWN_MS: 70,
      SWING: 0.03
    } : {
      LOOKAHEAD: 0.36,
      TICK_MS:   25,
      VOICE_BUDGET: 120,
      EGGS_PER_WAVE: 24,
      EGG_POOL: 64,
      MINI_AA_COOLDOWN_MS: 36,
      SWING: 0.04
    };

    // Mostra controlli solo post-success
    const url = new URL(location.href);
    if (url.searchParams.get('success') === '1') {
      controls.style.display = 'flex';
    }

    // Idle breathing
    chicken.classList.add('breathe');

    // ---------- Audio Context & Master ----------
    let ctx = null;
    let master, preSat, comp, hardLim;
    let NOISE_BUF = null;  // riuso noise (niente alloc/GC durante spam)

    function ac(){
      if (!ctx || ctx.state === 'closed') {
        // Lascia scegliere sampleRate al device (Android fix)
        ctx = new (window.AudioContext||window.webkitAudioContext)({ latencyHint:'interactive' });
      }
      return ctx;
    }

    function mkWaveShaper(curveFn){
      const c = ac();
      const n = 2048, curve = new Float32Array(n);
      for (let i=0;i<n;i++){ const x = i/n*2-1; curve[i] = curveFn(x); }
      const ws = c.createWaveShaper();
      ws.curve = curve; ws.oversample = '4x';
      return ws;
    }

    function buildMaster(){
      const c = ac();
      master = c.createGain();
      preSat = mkWaveShaper(x => Math.tanh((IS_MOBILE?18:12) * x));
      comp   = c.createDynamicsCompressor();
      comp.threshold.value = IS_MOBILE ? -6 : -10;
      comp.knee.value = 8; comp.ratio.value = IS_MOBILE ? 12 : 6;
      comp.attack.value = 0.002; comp.release.value = 0.10;
      hardLim = mkWaveShaper(x => Math.max(-0.9, Math.min(0.9, x)));
      master.connect(preSat).connect(comp).connect(hardLim).connect(c.destination);
      const now = c.currentTime + 0.001;
      master.gain.setValueAtTime(IS_MOBILE ? 1.18 : 1.10, now);

      // Prepara noise buffer (1s) riusabile
      if (!NOISE_BUF){
        NOISE_BUF = c.createBuffer(1, Math.floor(c.sampleRate * 1.0), c.sampleRate);
        const d = NOISE_BUF.getChannelData(0);
        for (let i=0;i<d.length;i++) d[i] = (Math.random()*2 - 1);
      }
    }

    function ensureMaster(){
      const c = ac();
      if (!master) buildMaster();
      if (master.context !== c) buildMaster();
      if (c.state !== 'running' && c.resume) { try { c.resume(); } catch(e){} }
      return c;
    }

    // --- Robust mobile unlock (Android/iOS) ---
    function unlockOnce(){
      const c = ensureMaster();
      try {
        const src = c.createBufferSource();
        const b = c.createBuffer(1, 1, c.sampleRate);
        src.buffer = b; src.connect(c.destination); src.start(0);
      } catch(e){}
      document.removeEventListener('pointerdown', unlockOnce);
      document.removeEventListener('touchstart', unlockOnce);
    }
    document.addEventListener('pointerdown', unlockOnce, {passive:true, once:true});
    document.addEventListener('touchstart',  unlockOnce, {passive:true, once:true});

    // Resume su ritorno tab (Android fix)
    document.addEventListener('visibilitychange', () => {
      const c = ctx; if (!c) return;
      if (document.visibilityState === 'visible' && c.state !== 'running' && c.resume) {
        try { c.resume(); } catch(e){}
      }
    });

    // ---------- Visual helpers ----------
    function setScream(on){
      stage.classList.toggle('scream', !!on);
      const shoutEl = stage.querySelector('.shout');
      if (!shoutEl) return;
      shoutEl.style.opacity = on ? '1' : '0';
      shoutEl.style.transform='translateX(-50%)';
    }
    function pulseWing(){
      stage.classList.add('beat');
      setTimeout(()=>stage.classList.remove('beat'), 150);
    }
    function pumpChickenAt(when){
      const c = ac();
      const ms = Math.max(0, (when - c.currentTime) * 1000);
      setTimeout(()=>{
        chicken.classList.remove('pump'); void chicken.offsetWidth; chicken.classList.add('pump');
        if (crestEl){ crestEl.classList.remove('bob'); void crestEl.offsetWidth; crestEl.classList.add('bob'); }
      }, ms);
    }
    function thumpAt(when){
      const c = ac();
      const ms = Math.max(0, (when - c.currentTime) * 1000);
      setTimeout(()=>{
        stage.style.transform='scale(1.012)';
        setTimeout(()=>{ stage.style.transform='scale(1)'; }, 90);
      }, ms);
    }

    // ---------- Egg Pool ----------
    const eggPool = [];
    function initEggPool(){
      if (eggPool.length) return;
      for (let i=0;i<PROF.EGG_POOL;i++){
        const e = document.createElement('span');
        e.className='egg'; e.textContent='🥚'; e.style.display='none';
        stage.appendChild(e); eggPool.push(e);
      }
    }
    function getEggEl(){
      for (const e of eggPool){ if (e.style.display==='none'){ e.style.display=''; return e; } }
      // se finito, riusa il primo (meglio visual continuo che allocare)
      return eggPool[0];
    }
    function releaseEggEl(e){ e.style.display='none'; e.textContent='🥚'; e.style.animation='none'; void e.offsetWidth; }

    // Mini "aa" (light throttle)
    let lastAATime = 0;
    function spawnMiniAAnearEl(el){
      const now = performance.now();
      if (now - lastAATime < PROF.MINI_AA_COOLDOWN_MS) return;
      lastAATime = now;
      const aa = document.createElement('span');
      aa.className='miniAA'; aa.textContent='aa';
      const r = el.getBoundingClientRect(), rs=stage.getBoundingClientRect();
      aa.style.left = (r.left - rs.left + 18) + 'px';
      aa.style.top  = (r.top  - rs.top  - 12) + 'px';
      stage.appendChild(aa);
      aa.style.animation='aaPop .24s ease-out forwards';
      setTimeout(()=>aa.remove(), 260);
    }

    // ---------- Audio building blocks ----------
    let VOICES_NOW = 0;
    function voiceUsed(forMs){ VOICES_NOW++; setTimeout(()=>{ VOICES_NOW--; }, forMs|0); }
    const LANES = [12,31,50,69,88];

    function hatClick(t, out, gain=0.42){
      const c = ac();
      const src = c.createBufferSource();
      src.buffer = NOISE_BUF;
      const hp=c.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=5000;
      const g = c.createGain();
      g.gain.setValueAtTime(gain, t);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.05);
      src.connect(hp).connect(g).connect(out);
      src.start(t);
      src.stop(t+0.06);
      voiceUsed((t - c.currentTime + 70)*1000);
    }

    function kickPlop(t, out){
      const c = ac();
      const o=c.createOscillator(); o.type='sine';
      const g=c.createGain();
      o.frequency.setValueAtTime(140,t);
      o.frequency.exponentialRampToValueAtTime(55,t+0.16);
      g.gain.setValueAtTime(1.05,t);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.18);
      o.connect(g).connect(out); o.start(t); o.stop(t+0.19);
      voiceUsed((t - c.currentTime + 200)*1000);
    }
    function snareCluck(t, out){
      const c = ac();
      const o=c.createOscillator(); o.type='square';
      const g=c.createGain();
      o.frequency.setValueAtTime(750,t);
      o.frequency.exponentialRampToValueAtTime(300,t+0.07);
      g.gain.setValueAtTime(0.95,t);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.1);
      o.connect(g).connect(out); o.start(t); o.stop(t+0.11);
      voiceUsed((t - c.currentTime + 120)*1000);
    }

    function mkDist(amt=20){ return mkWaveShaper(x=>Math.tanh(amt*x)); }

    function babyTherapyAA(t, out, {
      len=0.34, pitch=1.6, gain=0.62, detCents=10, tremHz=14, distAmt=18, voices=2, cluster=2, clusterGap=0.035
    } = {}){
      const c = ac();
      const headroom = Math.max(0, PROF.VOICE_BUDGET - VOICES_NOW);
      if (headroom < 4) { // se saturo, fai 1 solo blip corto
        voices = 1; cluster = 1; gain *= 0.6; len *= 0.7;
      }

      for (let k=0;k<cluster;k++){
        const tt = t + k*clusterGap;

        const bus=c.createGain(); bus.gain.setValueAtTime(0.0001,tt);
        bus.gain.exponentialRampToValueAtTime(gain,tt+0.02);
        bus.gain.exponentialRampToValueAtTime(0.0001,tt+len);

        const dist=mkDist(distAmt), bp=c.createBiquadFilter(), lp=c.createBiquadFilter();
        bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=5;
        lp.type='lowpass';  lp.frequency.value=3300;
        const sum=c.createGain(); sum.connect(dist).connect(bp).connect(lp).connect(bus).connect(out);

        for(let v=0; v<voices; v++){
          if (VOICES_NOW >= PROF.VOICE_BUDGET) break;
          const o=c.createOscillator(); o.type='sawtooth';
          const g=c.createGain();
          const f0=620*pitch;
          o.frequency.setValueAtTime(f0,tt);
          o.detune.setValueAtTime(v===0?-detCents:+detCents,tt);
          o.frequency.linearRampToValueAtTime(f0*1.16, tt+0.05);
          o.frequency.exponentialRampToValueAtTime(f0*0.26, tt+len*0.85);
          g.gain.setValueAtTime(0.0001,tt);
          g.gain.exponentialRampToValueAtTime(0.95,tt+0.035);
          g.gain.exponentialRampToValueAtTime(0.0001,tt+len);

          const trem=c.createOscillator(); trem.frequency.value=tremHz;
          const tremAmt=c.createGain(); tremAmt.gain.value=0.7;
          trem.connect(tremAmt.gain); g.connect(tremAmt);
          o.connect(g).connect(sum);
          trem.start(tt); trem.stop(tt+len);
          o.start(tt); o.stop(tt+len);
          voiceUsed((tt - c.currentTime + len + 20/1000)*1000);
        }

        // noise layer riusando buffer
        if (VOICES_NOW < PROF.VOICE_BUDGET){
          const n=c.createBufferSource(); n.buffer=NOISE_BUF;
          const nBP=c.createBiquadFilter(); nBP.type='bandpass'; nBP.frequency.value=2400; nBP.Q.value=6;
          const ng=c.createGain(); ng.gain.setValueAtTime(0.001, tt+0.03);
          ng.gain.exponentialRampToValueAtTime(0.26, tt+0.08);
          ng.gain.exponentialRampToValueAtTime(0.0001, tt+len);
          n.connect(nBP).connect(ng).connect(sum);
          n.start(tt); n.stop(tt+len);
          voiceUsed((tt - c.currentTime + len + 20/1000)*1000);
        }
      }
    }

    // ---------- Visual eggs ----------
    function dropEggAt(lanePct, at, hatchMode){
      const c=ac(); const ms=Math.max(0,(at - c.currentTime)*1000);
      setTimeout(()=>{
        const e=getEggEl();
        const size=30 + Math.round(Math.random()*8);
        e.style.fontSize = size+'px';
        e.style.left = `calc(${lanePct}% - ${size/2}px)`;
        e.style.setProperty('--x', (Math.random()*8 - 4) + 'px');
        e.style.animation='none'; void e.offsetWidth;
        e.style.animation='fall 1.12s linear forwards';

        if (hatchMode){
          if (hatchMode==='air'){
            setTimeout(()=>{ e.textContent='🐣'; spawnMiniAAnearEl(e); }, 480);
            if (master) babyTherapyAA(c.currentTime+0.48, master, { cluster:2, voices:2, pitch:1.65 });
          } else {
            setTimeout(()=>{ e.textContent='🐣'; spawnMiniAAnearEl(e); }, 1080);
            if (master) babyTherapyAA(c.currentTime+1.08, master, { cluster:2, voices:2, pitch:1.55 });
          }
        }

        setTimeout(()=>releaseEggEl(e), 1500);
      }, ms);
    }

    // ---------- Scream (3s) ----------
    function chickenScream3s(t, out){
      const c = ac();
      setScream(true);
      const len=3.0;
      const bus=c.createGain(); bus.gain.value=1.0;
      const dist=mkDist(20);
      const bp=c.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=4.5;
      const lp=c.createBiquadFilter(); lp.type='lowpass';  lp.frequency.value=2800;
      bus.connect(dist).connect(bp).connect(lp).connect(out);

      [-10,+10].forEach(det=>{
        const o=c.createOscillator(); o.type='sawtooth';
        const g=c.createGain();
        o.frequency.setValueAtTime(620,t);
        o.detune.setValueAtTime(det,t);
        o.frequency.linearRampToValueAtTime(720, t+0.12);
        o.frequency.exponentialRampToValueAtTime(150, t+len*0.92);
        g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(0.95,t+0.06);
        g.gain.exponentialRampToValueAtTime(0.0001,t+len);

        const trem=c.createOscillator(); trem.frequency.value=13;
        const tremAmt=c.createGain(); tremAmt.gain.value=0.7;
        trem.connect(tremAmt.gain); g.connect(tremAmt);
        o.connect(g).connect(bus);
        trem.start(t); trem.stop(t+len);
        o.start(t); o.stop(t+len);
        voiceUsed((t - c.currentTime + len + 20/1000)*1000);
      });

      // noise layer per scream
      const n=c.createBufferSource(); n.buffer=NOISE_BUF;
      const nBP=c.createBiquadFilter(); nBP.type='bandpass'; nBP.frequency.value=2600; nBP.Q.value=6;
      const ng=c.createGain(); ng.gain.setValueAtTime(0.05, t+0.08);
      ng.gain.exponentialRampToValueAtTime(0.5, t+0.22);
      ng.gain.exponentialRampToValueAtTime(0.0001, t+len);
      n.connect(nBP).connect(ng).connect(bus);
      n.start(t); n.stop(t+len);
      voiceUsed((t - c.currentTime + len + 20/1000)*1000);

      // tick + uova leggere durante lo scream per continuità
      for (let x=t+0.10; x < t+len-0.06; x += 0.25){
        hatClick(x, out, 0.18);
        const lane = (Math.round((x - t)/0.25) % 2) ? 31 : 50;
        dropEggAt(lane, x, null);
      }

      setTimeout(()=>setScream(false), (len*1000)+60);
      return t+len;
    }

    // ---------- Measure 2s (kick/snare + swing hats + eggs + AA) ----------
    function scheduleMeasure(start, out){
      const c = ac();
      const dur=2.0, beat=0.5;
      for(let i=0;i<4;i++){
        const t = start + i*beat;

        pulseWing();
        pumpChickenAt(t);
        if (i===0 || i===2){ kickPlop(t,out); thumpAt(t); } else { snareCluck(t,out); }

        // quarti
        hatClick(t,out,0.42);
        dropEggAt([12,69,31,88][i], t, Math.random()<0.18 ? (Math.random()<0.5?'air':'ground') : null);

        // off-beat con swing
        const off = t + beat/2 + (PROF.SWING*beat);
        hatClick(off,out,0.42);
        dropEggAt([50,31,50,69][i], off, Math.random()<0.28 ? (Math.random()<0.5?'air':'ground') : null);

        // mini “aa”
        if (Math.random() < 0.85){
          babyTherapyAA(off, out, { cluster:2, voices:2 });
        }
      }
      return start + dur;
    }

    // ---------- Transient punch ----------
    function transientPunch(mult=1){
      const c=ac(); if (!master) return;
      const now=c.currentTime+0.001;
      try{
        const base = IS_MOBILE ? 1.18 : 1.10;
        master.gain.cancelScheduledValues(now);
        master.gain.setValueAtTime(base, now);
        master.gain.linearRampToValueAtTime(base * (1.12*mult), now + 0.02);
        master.gain.linearRampToValueAtTime(base, now + 0.12);
      }catch(e){}
    }

    // ---------- LOOP SCHEDULER (rolling, drift-proof) ----------
    let isRunning = false;
    let schedTimer = null;
    let timelineEnd = 0;  // fino a dove ho schedulato
    let MEASURE = 0;

    function scheduleChunk(fromTime){
      // pattern: 3s scream + 2s measure = 5s totale
      const c = ac();
      const afterS = chickenScream3s(fromTime, master);
      scheduleMeasure(afterS+0.06, master);
      return fromTime + 5.0;
    }

    function schedulerTick(){
      if (!isRunning) return;
      const c = ac();
      const horizon = c.currentTime + PROF.LOOKAHEAD;
      while (timelineEnd < horizon){
        // trigger visual progress bar per blocco
        stage.classList.add('playing');
        bar.style.animation='none'; bar.offsetHeight; bar.style.animation=null;
        timelineEnd = scheduleChunk(timelineEnd || (c.currentTime + 0.08));
      }
    }

    function startLoop(){
      ensureMaster(); initEggPool();

      // reset stato
      isRunning = true;
      timelineEnd = 0;
      MEASURE = 0;

      // (ri)attiva scheduler
      if (schedTimer) clearInterval(schedTimer);
      schedTimer = setInterval(schedulerTick, PROF.TICK_MS);

      // punch e via
      transientPunch(1.05);
      bar.style.animation='none'; bar.offsetHeight; bar.style.animation=null;

      startBtn.style.display='none';
      stopBtn.style.display='inline-block';
    }

    function stopLoop(){
      if (!isRunning) return;
      isRunning = false;

      if (schedTimer){ clearInterval(schedTimer); schedTimer = null; }

      // fade out veloce del master (senza chiudere il context)
      const c = ac(); const now=c.currentTime;
      try{
        master.gain.cancelScheduledValues(now);
        master.gain.setValueAtTime(master.gain.value, now);
        master.gain.linearRampToValueAtTime(0.0001, now + 0.10);
      }catch(e){}

      stage.classList.remove('playing'); setScream(false);

      startBtn.style.display='inline-block';
      stopBtn.style.display='none';
    }

    // ---------- EGGSplosion (spammabile con coalescing) ----------
    let lastBurstAt = 0;
    let queuedBursts = 0;

    function doBurst(){
      const c=ensureMaster();
      initEggPool();
      transientPunch(1.08);

      const base = c.currentTime + 0.02;
      const waves = 3;                             // compatto, forte
      const step  = IS_MOBILE ? 0.022 : 0.018;
      const extra = Math.min(queuedBursts, 4);     // coalesce: più tap => più densità
      const eggsPer = PROF.EGGS_PER_WAVE + extra*4;

      for(let w=0; w<waves; w++){
        const wBase = base + w*0.34;
        for(let i=0;i<eggsPer;i++){
          const t = wBase + i*step;
          const lane = LANES[Math.floor(Math.random()*LANES.length)];
          const mode = (Math.random()<0.7?'air':'ground');
          dropEggAt(lane, t, mode);

          const headroom = Math.max(0, PROF.VOICE_BUDGET - VOICES_NOW);
          if (headroom >= 6 && master){
            // riduci cluster se sei tirato
            const cl = headroom > 20 ? 3 : 2;
            babyTherapyAA(t+0.012, master, { cluster:cl, voices:2, pitch:1.55 + Math.random()*0.2 });
          }
        }
      }
      queuedBursts = 0;
    }

    function triggerBurst(){
      const now = performance.now();
      // min spacing fra ondate (coalesce) — non blocca lo spam, lo accorpa
      if (now - lastBurstAt < 90){
        queuedBursts++;
        return;
      }
      lastBurstAt = now;
      queuedBursts++;
      // esegui al prossimo frame per accorpare tap ravvicinati
      requestAnimationFrame(doBurst);
    }

    // ---------- Buttons wiring ----------
    if (startBtn){
      startBtn.addEventListener('pointerdown', startLoop, {passive:true});
      stopBtn .addEventListener('pointerdown', stopLoop,  {passive:true});
      eggBtn  .addEventListener('pointerdown', triggerBurst, {passive:true});

      // pre-warm (solo unlock, non once su start/egg)
      startBtn.addEventListener('pointerdown', ensureMaster, {passive:true, once:true});
      eggBtn  .addEventListener('pointerdown', ensureMaster, {passive:true, once:true});
    }
  })();
  </script>
</body>
</html>








































































